{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/consolidado.css') }}">
<style>
    /* === SOCIAL STYLE === */
    .profile-header-social {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .cover-photo {
        height: 200px;
        background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
        position: relative;
    }

    .profile-info-bar {
        padding: 0 30px 20px 30px;
        position: relative;
        display: flex;
        align-items: flex-end;
    }

    .avatar-large {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 5px solid white;
        margin-top: -60px;
        margin-right: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .user-details h1 {
        margin: 0;
        font-size: 24px;
        color: #333;
    }

    .user-details p {
        margin: 5px 0 0 0;
        color: #666;
    }

    .badges {
        gap: 5px;
        display: flex;
        margin-top: 10px;
    }

    .badge-pill {
        background: #eef2f7;
        color: #555;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
    }

    .social-grid {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
    }

    .social-sidebar .card {
        padding: 20px;
        margin-bottom: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .info-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .info-list li {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }

    .info-list li:last-child {
        border: none;
    }

    .info-label {
        font-weight: bold;
        color: #555;
        display: block;
        margin-bottom: 3px;
    }

    .status-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }

    .timeline-post {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #eee;
        position: relative;
    }

    .post-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .post-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .post-meta small {
        color: #999;
        display: block;
    }

    .type-visit {
        color: #9c27b0;
    }

    .type-budget {
        color: #28a745;
    }

    .type-note {
        color: #666;
    }
</style>
{% endblock %}

{% block content %}

<div class="view-container">

    <div class="profile-header-social">
        <div class="cover-photo">
            <!-- Could be a map or project photo -->
        </div>
        <div class="profile-info-bar">
            <img src="{{ client.avatar }}" class="avatar-large">
            <div class="user-details">
                <h1>{{ client.nome }} <small style="font-size:14px; color:#999; font-weight:normal;">(ID: {{ client.id
                        }})</small></h1>
                <p>{{ client.cidade }} - {{ client.estado }}</p>
                <div class="badges">
                    {% for tag in client.tags %}
                    <span class="badge-pill">{{ tag }}</span>
                    {% endfor %}
                    <span class="badge-pill" style="background:#e3f2fd; color:#0d47a1;"> Total Gasto: {{
                        client.total_spent }}</span>
                </div>
            </div>
            <div style="margin-left:auto;">
                <button class="btn btn-secondary"
                    onclick="window.location.href='https://wa.me/55{{ client.whatsapp|replace(' ','')|replace('-','')|replace('(','')|replace(')','') }}'">üìû
                    WhatsApp</button>
                <button class="btn btn-primary" onclick="openOrcamentoModal()">‚ûï Novo Or√ßamento</button>
            </div>
        </div>
    </div>

    <div class="social-grid">
        <!-- Sidebar Info -->
        <div class="social-sidebar">
            <div class="card">
                <h3>Sobre</h3>
                <ul class="info-list">
                    <li><span class="info-label">Email</span> {{ client.email or 'N/A' }}</li>
                    <li><span class="info-label">Telefone</span> {{ client.telefone or 'N/A' }}</li>
                    <li><span class="info-label">Endere√ßo</span> {{ client.logradouro }}, {{ client.numero }} - {{
                        client.bairro }}</li>
                    <li><span class="info-label">CPF/CNPJ</span> {{ client.cpf_cnpj or 'N/A' }}</li>
                    <li><span class="info-label">Status</span> <span style="color:green">‚óè {{ client.status }}</span>
                    </li>
                    <li id="ai-summary-item"
                        style="display:none; background: #f0f7ff; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <span class="info-label" style="color: #007bff; display: flex; align-items: center; gap: 5px;">
                            ‚ú® Resumo da IA (Camila)
                        </span>
                        <p id="ai-summary-text"
                            style="font-size: 13px; font-style: italic; color: #444; margin-top: 5px; line-height: 1.4;">
                            Carregando resumo...
                        </p>
                    </li>
                </ul>
            </div>

            <div class="card">
                <h3>Or√ßamentos Recentes</h3>
                {% for bud in budgets[:3] %}
                <div style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">
                    <a href="/orcamentos?id={{ bud.id }}" style="font-weight:bold;">#{{ bud.id }}</a>
                    <span style="font-size:12px; float:right;">{{ bud.status }}</span>
                    <div style="font-size:12px;">R$ {{ bud.total }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Main Feed -->
        <div class="feed">
            <div class="status-box">
                <input type="text" id="postInput" placeholder="Escreva uma observa√ß√£o, cole uma nota ou agende algo..."
                    class="form-control" style="margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <button class="btn btn-sm btn-secondary">üì∑ Foto</button>
                        <button class="btn btn-sm btn-secondary">üìÖ Agendar</button>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="postActivity()">Postar</button>
                </div>
            </div>

            <h3>Linha do Tempo</h3>

            <div id="timeline-container">
                {% for event in timeline %}
                <div class="timeline-post">
                    <div class="post-header">
                        <img src="https://ui-avatars.com/api/?name={{ event.user }}&background=random"
                            class="post-avatar">
                        <div class="post-meta">
                            <strong>{{ event.title }}</strong>
                            <small>{{ event.date }} ‚Ä¢ por {{ event.user }}</small>
                        </div>
                        <div class="post-type-icon type-{{ event.type }}" style="margin-left:auto;">
                            {% if event.type == 'visit' %}üìç{% elif event.type == 'budget' %}üí∞{% elif event.type ==
                            'note' %}üìù{% endif %}
                        </div>
                    </div>
                    <p>{{ event.desc }}</p>
                </div>
                {% endfor %}
            </div>

        </div>
    </div>

</div>

<script>
    function postActivity() {
        const text = document.getElementById('postInput').value;
        if (!text) return alert("Escreva algo!");

        fetch(`/api/cliente/{{ client.id }}/activity`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: 'Nota R√°pida',
                desc: text,
                type: 'note'
            })
        }).then(r => r.json()).then(res => {
            if (res.success) location.reload();
            else alert("Erro ao postar");
        });
    }

    function openOrcamentoModal() {
        // Redirect to orcamentos with client pre-selected (simple v1)
        window.location.href = '/orcamentos?action=new&client_id={{ client.id }}';
    }

    // Fetch AI Summary
    fetch(`/api/cliente/{{ client.id }}/ai-summary`)
        .then(r => r.json())
        .then(data => {
            if (data.summary) {
                document.getElementById('ai-summary-item').style.display = 'block';
                document.getElementById('ai-summary-text').textContent = data.summary;
            }
        });
</script>

{% endblock %}