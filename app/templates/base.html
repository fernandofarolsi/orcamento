<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>{{ company.empresa_nome }}</title>

  <!-- PWA & iOS Meta Tags -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#F2F2F7">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.png') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/consolidado.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-ios.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}");
      });
    }
  </script>
  {% block head %}{% endblock %}
</head>

<body>
  <div class="app-background-aurora" style="background-image: url('{{ company.empresa_logo_url }}');"></div>
  <div class="app-logo-watermark" style="background-image: url('{{ company.empresa_logo_url }}');"></div>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div id="flash-messages" style="position: fixed; top: 20px; right: 20px; z-index: 2000;">
    {% for category, message in messages %}
    <div class="flash-message {{ category }}">
      {{ message }}</div>
    {% endfor %}
  </div>
  <script>
    setTimeout(() => {
      const msgs = document.getElementById('flash-messages');
      if (msgs) msgs.style.display = 'none';
    }, 4000);
  </script>
  {% endif %}
  {% endwith %}

  {% if request.endpoint != 'login' and request.endpoint != 'auth.login' %}
  <!-- Desktop Sidebar -->
  <nav class="sidebar-desktop">
    <div class="logo-container">
      <img src="{{ company.empresa_logo_url }}" alt="{{ company.empresa_nome }}">
    </div>

    <div class="nav-links">
      <a href="/dashboard" class="{{ 'active' if request.endpoint == 'dashboard' else '' }}" title="Dashboard">
        <i class="fas fa-chart-pie"></i>
      </a>
      <a href="/kanban" class="{{ 'active' if request.endpoint == 'kanban' else '' }}" title="Kanban">
        <i class="fas fa-columns"></i>
      </a>
      <a href="/orcamentos" class="{{ 'active' if request.endpoint == 'orcamentos' else '' }}" title="Orçamentos">
        <i class="fas fa-file-invoice-dollar"></i>
      </a>
      <a href="/clientes" class="{{ 'active' if request.endpoint == 'clientes' else '' }}" title="Clientes">
        <i class="fas fa-users"></i>
      </a>
      <a href="/estoque" class="{{ 'active' if request.endpoint == 'estoque' else '' }}" title="Estoque">
        <i class="fas fa-boxes"></i>
      </a>
      <a href="/catalogo" class="{{ 'active' if request.endpoint == 'catalogo' else '' }}" title="Catálogo">
        <i class="fas fa-book"></i>
      </a>
      <!--
      <a href="/discovery" class="{{ 'active' if request.endpoint == 'discovery' else '' }}"
        title="Descoberta de Móveis">
        <i class="fas fa-magic"></i>
      </a>
      -->
      <a href="/financeiro" class="{{ 'active' if request.endpoint == 'financeiro' else '' }}" title="Financeiro">
        <i class="fas fa-wallet"></i>
      </a>
      <a href="/funcionarios" class="{{ 'active' if request.endpoint == 'funcionarios' else '' }}" title="Funcionários">
        <i class="fas fa-id-card"></i>
      </a>

      {% if current_user and current_user.role == 'admin' %}
      <a href="/settings" class="{{ 'active' if request.endpoint == 'settings' else '' }}" title="Configurações">
        <i class="fas fa-cog"></i>
      </a>
      {% endif %}

      <div style="margin-top: auto; padding-bottom: 20px; width: 100%; display: flex; justify-content: center;">
        <form action="/api/auth/logout" method="POST" class="logout-form"
          style="margin:0; display: flex; justify-content: center; width: 100%;"
          onsubmit="event.preventDefault(); fetch('/api/auth/logout', {method: 'POST'}).then(() => window.location.href='/login');">
          <button type="submit" title="Sair"
            style="background:transparent; border:none; color:var(--text-muted); cursor:pointer; font-size:1.2rem; transition:0.3s; display: flex; align-items: center; justify-content: center; width: 50px; height: 50px;"
            onmouseover="this.style.color='var(--accent-magenta)'" onmouseout="this.style.color='var(--text-muted)'">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </form>
      </div>
    </div>
  </nav>

  <!-- Mobile Bottom Tab Bar -->
  <nav class="mobile-tabbar">
    <a href="/kanban" class="tab-link {{ 'active' if request.endpoint == 'kanban' else '' }}">
      <i class="fas fa-columns"></i>
      <span>Início</span>
    </a>
    <a href="/orcamentos" class="tab-link {{ 'active' if request.endpoint == 'orcamentos' else '' }}">
      <i class="fas fa-file-invoice-dollar"></i>
      <span>Orça..</span>
    </a>
    <a href="/estoque" class="tab-link {{ 'active' if request.endpoint == 'estoque' else '' }}">
      <i class="fas fa-boxes"></i>
      <span>Estoque</span>
    </a>
    <a href="/financeiro" class="tab-link {{ 'active' if request.endpoint == 'financeiro' else '' }}">
      <i class="fas fa-wallet"></i>
      <span>Financ.</span>
    </a>
    <!--
    <a href="/discovery" class="tab-link {{ 'active' if request.endpoint == 'discovery' else '' }}">
      <i class="fas fa-magic"></i>
      <span>Descoberta</span>
    </a>
    -->
    <a href="/settings" class="tab-link {{ 'active' if request.endpoint == 'settings' else '' }}">
      <i class="fas fa-bars"></i>
      <span>Mais</span>
    </a>
  </nav>

  <div class="main-content">
    <header class="mobile-header">
      <h1>{{ company.empresa_nome }}</h1>
      <img src="{{ company.empresa_logo_url }}" alt="{{ company.empresa_nome }}" class="mobile-logo">
    </header>
    {% endif %}

    {% block content %}{% endblock %}

    {% if request.endpoint != 'login' and request.endpoint != 'auth.login' %}
  </div>
  {% endif %}
</body>

</html>