{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/consolidado.css') }}">
<style>
    /* Custom styles for high-density components that need obsidian variants */
    .holerite-modal {
        max-width: 650px !important;
    }

    /* Updated Timeline/Item styles for Obsidian */
    .holerite-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--glass-border);
        color: var(--text-primary);
    }

    .holerite-total {
        margin-top: 20px;
        padding: 15px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        font-weight: 800;
        font-size: 1.3rem;
        display: flex;
        justify-content: space-between;
        color: var(--accent-cyan);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
    }

    /* Tab styles synced with Obsidian Ethereal */
    .tab-container {
        display: flex;
        border-bottom: 1px solid var(--glass-border);
        margin-bottom: 25px;
        gap: 15px;
        overflow-x: auto;
        padding-bottom: 5px;
    }

    .tab-btn {
        padding: 12px 24px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-muted);
        border-bottom: 3px solid transparent;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        white-space: nowrap;
        font-size: 0.95rem;
        letter-spacing: 0.5px;
    }

    .tab-btn:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.05);
    }

    .tab-btn.active {
        color: var(--primary-neon);
        border-bottom-color: var(--primary-neon);
        text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
    }

    .tab-content {
        display: none;
        animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .tab-content.active {
        display: block;
    }

    @keyframes slideUpFade {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Action buttons consistency */
    .action-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        padding: 8px;
        transition: 0.3s;
        cursor: pointer;
    }

    .action-btn:hover {
        background: var(--glass-bg);
        border-color: var(--primary-neon);
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="clientes-container">
    <div class="flex-between mb-30">
        <div>
            <h1 class="neon-text-cyan" style="margin:0; font-size: 2.5rem;">RH & Talentos</h1>
            <p class="text-muted" style="margin-top: 5px;">Gest√£o de capital humano e performance</p>
        </div>
        <div class="flex gap-15">
            <label class="flex gap-10"
                style="align-items: center; cursor: pointer; font-size: 0.95em; color: var(--text-muted); background: var(--glass-bg); padding: 8px 15px; border-radius: 20px; border: 1px solid var(--glass-border);">
                <input type="checkbox" id="showInativos" onchange="renderTable(funcionarios)"
                    style="accent-color: var(--primary-neon);"> Mostrar Inativos
            </label>
            <button class="btn btn-secondary glass-btn" onclick="openImportModal()">üìÇ Importar Ponto</button>
            <button class="btn btn-success glass-btn" onclick="bulkHolerite()"
                style="border-color: var(--accent-cyan);">üí∞ Gerar Holerites</button>
            <button class="btn btn-primary glass-btn neon-border-cyan" onclick="openModal()">+ Admitir
                Funcion√°rio</button>
        </div>
    </div>

    <!-- Tabela -->
    <div class="glass-panel" style="padding: 0; overflow: hidden;">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>Colaborador</th>
                    <th>Cargo / Fun√ß√£o</th>
                    <th>Status</th>
                    <th>Remunera√ß√£o</th>
                    <th style="text-align: center;">A√ß√µes √Ågeis</th>
                </tr>
            </thead>
            <tbody id="listaFuncionarios">
                <!-- JS Preenche -->
            </tbody>
        </table>
    </div>

    <!-- Modal √önico de Funcion√°rio (Perfis e A√ß√µes) -->
    <div id="funcModal" class="modal">
        <div class="modal-content glass-panel"
            style="max-width: 900px; padding: 40px; border: 1px solid var(--glass-border);">
            <div class="flex-between mb-30">
                <h2 id="modalTitle" class="neon-text-cyan">Perfil do Colaborador</h2>
                <button class="btn glass-btn" onclick="closeModal()" style="padding: 5px 15px;">&times; Sair</button>
            </div>

            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('cadastro')" id="btn-tab-cadastro">üë§
                    Cadastro</button>
                <button class="tab-btn" onclick="switchTab('historico')" id="btn-tab-historico">üìú Hist√≥rico</button>
                <button class="tab-btn" onclick="switchTab('holerite')" id="btn-tab-holerite">üí∞ Holerite</button>
                <button class="tab-btn" onclick="switchTab('ponto')" id="btn-tab-ponto">üïí Folha de Ponto</button>
                <button class="tab-btn" onclick="switchTab('desligamento')" id="btn-tab-desligamento"
                    style="color: var(--danger-color);">üëã Rescis√£o</button>
            </div>

            <!-- TAB: CADASTRO -->
            <div id="tab-cadastro" class="tab-content active">
                <form id="funcForm" onsubmit="saveFunc(event)">
                    <input type="hidden" id="funcId">

                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="nome" required>
                    </div>

                    <div class="form-group">
                        <label>Cargo</label>
                        <input type="text" id="cargo" required>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Sal√°rio Base (R$)</label>
                            <input type="number" step="0.01" id="salario_base" required>
                        </div>
                        <div class="form-group">
                            <label>INSS (%)</label>
                            <input type="number" step="0.01" id="inss_percent" value="0.11" placeholder="0.11">
                        </div>
                        <div class="form-group">
                            <label>FGTS (%)</label>
                            <input type="number" step="0.01" id="fgts_percent" value="0.08" placeholder="0.08">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nome no Ponto (XLS)</label>
                        <input type="text" id="nome_ponto" placeholder="Ex: FELIPE">
                        <small>Nome exato como aparece no arquivo de ponto</small>
                    </div>

                    <div class="form-group" id="contratacaoGroup">
                        <label>Data de Contrata√ß√£o</label>
                        <input type="date" id="data_contratacao">
                        <small>Se preenchido, o primeiro per√≠odo ser√° criado automaticamente.</small>
                    </div>

                    <div class="form-group">
                        <label>Descontos Fixos (JSON)</label>
                        <textarea id="descontos_json" rows="3"
                            placeholder='[{"tipo": "vale", "valor": 100}]'>[]</textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Salvar Altera√ß√µes no
                            Cadastro</button>
                    </div>
                </form>
            </div>

            <!-- TAB: HIST√ìRICO -->
            <div id="tab-historico" class="tab-content">
                <div class="flex-between">
                    <h3>Per√≠odos de Trabalho</h3>
                    <button class="btn btn-primary btn-sm" onclick="openNewPeriodForm()">+ Novo Per√≠odo</button>
                </div>

                <div id="periodFormContainer"
                    style="display: none; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #eee;">
                    <h4 id="periodFormTitle" style="margin-top: 0;">Novo Per√≠odo</h4>
                    <form onsubmit="savePeriod(event)">
                        <input type="hidden" id="periodId">
                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label>Data Contrata√ß√£o</label>
                                <input type="date" id="p_data_contratacao" required>
                            </div>
                            <div class="form-group">
                                <label>Data Demiss√£o</label>
                                <input type="date" id="p_data_demissao">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Motivo Sa√≠da / Obs</label>
                            <input type="text" id="p_motivo_saida" placeholder="Ex: Pedido de demiss√£o">
                        </div>
                        <div class="form-actions" style="margin-top: 10px;">
                            <button type="button" class="btn btn-secondary"
                                onclick="closePeriodForm()">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar Per√≠odo</button>
                        </div>
                    </form>
                </div>

                <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead style="background: #f0f0f0;">
                            <tr>
                                <th style="padding: 8px;">Contrata√ß√£o</th>
                                <th style="padding: 8px;">Demiss√£o</th>
                                <th style="padding: 8px;">Motivo</th>
                                <th style="padding: 8px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="periodoListBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: HOLERITE -->
            <div id="tab-holerite" class="tab-content">
                <div class="flex-between">
                    <h3>Pr√©via de Holerite</h3>
                    <input type="month" id="holeriteMes" onchange="recalcHolerite()" style="width: auto;">
                </div>
                <div id="holeriteContent" style="margin-top: 15px;">
                    <!-- JS Preenche -->
                </div>
                <div class="form-actions" style="margin-top: 15px; gap: 10px;">
                    <button type="button" class="btn btn-primary" onclick="printHolerite()" style="flex:1;">üñ®Ô∏è
                        Imprimir</button>
                    <button type="button" class="btn btn-success" id="btnFinalizarFinanceiro"
                        onclick="finalizeHolerite()" style="flex:2; background-color: #27ae60;">üí∞ Lan√ßar no
                        Financeiro</button>
                </div>
            </div>

            <!-- TAB: PONTO -->
            <div id="tab-ponto" class="tab-content">
                <div class="flex-between">
                    <h3>Espelho de Ponto</h3>
                    <input type="month" id="pontoMes" onchange="loadPontoRecords()" style="width: auto;">
                </div>
                <div style="max-height: 350px; overflow-y: auto; margin-top: 10px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead style="background: #f0f0f0; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 5px;">Data</th>
                                <th style="padding: 5px;">Ent 1</th>
                                <th style="padding: 5px;">Sai 1</th>
                                <th style="padding: 5px;">Ent 2</th>
                                <th style="padding: 5px;">Sai 2</th>
                                <th style="padding: 5px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="pontoBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: DESLIGAMENTO -->
            <div id="tab-desligamento" class="tab-content">
                <h3 style="color: var(--danger-color);">Simula√ß√£o de Rescis√£o</h3>
                <div class="form-group">
                    <label>Data de Demiss√£o</label>
                    <input type="date" id="rescisaoData" onchange="loadRescisaoCalc()" required>
                </div>

                <div id="rescisaoResult"
                    style="margin-top: 15px; background: rgba(255, 150, 0, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 150, 0, 0.2); display:none; color: var(--text-primary);">
                    <!-- JS Preenche -->
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label>Motivo da Sa√≠da</label>
                    <input type="text" id="rescisaoMotivo" placeholder="Ex: Pedido de demiss√£o">
                </div>

                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="width: 100%;"
                        onclick="confirmDismissal()">Confirmar Demiss√£o üëã</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Importa√ß√£o Ponto -->
    <div id="importModal" class="modal">
        <div class="modal-content glass-panel"
            style="max-width: 500px; padding: 35px; border: 1px solid var(--glass-border);">
            <h2 class="neon-text-cyan mb-20">Importa√ß√£o Biom√©trica</h2>
            <p class="text-muted mb-20">Selecione o arquivo XLS exportado do rel√≥gio para processamento autom√°tico.</p>

            <div class="form-group mb-20">
                <input type="file" id="pontoFile" accept=".xls,.xlsx" class="glass-input" style="padding: 15px;">
            </div>

            <div id="importLog"
                style="margin-top:15px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; display: none; font-size: 0.85em; color: var(--accent-cyan); border: 1px solid var(--glass-border);">
            </div>

            <div class="form-actions mt-30">
                <button class="btn glass-btn"
                    onclick="document.getElementById('importModal').classList.remove('show')">Cancelar</button>
                <button class="btn btn-primary glass-btn neon-border-cyan" onclick="uploadPonto()">Processar
                    Dados</button>
            </div>
        </div>
    </div>

    <!-- Modal Vale -->
    <div id="valeModal" class="modal">
        <div class="modal-content glass-panel"
            style="max-width: 500px; padding: 35px; border: 1px solid var(--glass-border);">
            <h2 class="neon-text-magenta">Adiantamento de Sal√°rio</h2>
            <h4 id="valeFuncNome" style="margin-top: 5px; color: var(--text-muted); font-weight: 400;"></h4>
            <form onsubmit="saveVale(event)" class="mt-25">
                <input type="hidden" id="valeFuncId">

                <div class="form-group">
                    <label>Valor do Vale (R$)</label>
                    <input type="number" step="0.01" id="valeValor" class="glass-input" required placeholder="0,00">
                </div>

                <div class="form-group">
                    <label>Data de Libera√ß√£o</label>
                    <input type="date" id="valeData" class="glass-input" required>
                </div>

                <div class="form-group">
                    <label>Observa√ß√£o / Descritivo</label>
                    <input type="text" id="valeDesc" class="glass-input" required
                        placeholder="Ex: Adiantamento emergencial">
                </div>

                <div class="form-actions" style="margin-top: 30px;">
                    <button type="button" class="btn glass-btn"
                        onclick="document.getElementById('valeModal').classList.remove('show')">Voltar</button>
                    <button type="submit" class="btn btn-primary glass-btn neon-border-magenta"
                        style="background: rgba(255, 0, 255, 0.1);">Registrar Vale</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let funcionarios = [];
        let currentFuncIdPonto = null;

        function loadFuncionarios() {
            fetch('/api/funcionarios')
                .then(r => r.json())
                .then(data => {
                    funcionarios = data;
                    renderTable(data);
                });
        }

        function renderTable(data) {
            const tbody = document.getElementById('listaFuncionarios');
            const showInativos = document.getElementById('showInativos').checked;
            tbody.innerHTML = '';

            data.forEach(f => {
                const isDemitidoRecente = f.status_emprego === 'Demitido (M√™s Atual)';
                if (!showInativos && f.status_emprego === 'Inativo') return;

                let statusBadge = '';
                if (f.status_emprego === 'Ativo') {
                    statusBadge = '<span class="status-badge" style="background: rgba(0, 255, 136, 0.1); color: #00ff88; border: 1px solid rgba(0, 255, 136, 0.3);">Ativo</span>';
                } else if (f.status_emprego === 'Inativo') {
                    statusBadge = '<span class="status-badge" style="background: rgba(255, 68, 68, 0.1); color: #ff4444; border: 1px solid rgba(255, 68, 68, 0.3);">Inativo</span>';
                } else {
                    statusBadge = '<span class="status-badge" style="background: rgba(255, 170, 0, 0.1); color: #ffaa00; border: 1px solid rgba(255, 170, 0, 0.3);">Rescis√£o</span>';
                }

                const isInactive = f.status_emprego === 'Inativo';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>
                    <div style="font-weight: 600; color: var(--text-primary);">${f.nome}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${f.nome_ponto || 'Sem ID Biom√©trico'}</div>
                </td>
                <td><span class="text-muted">${f.cargo || '-'}</span></td>
                <td>${statusBadge}</td>
                <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-cyan);">R$ ${parseFloat(f.salario_base).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td style="text-align: center;">
                    <div class="flex gap-10" style="justify-content: center;">
                    ${!isInactive ? `<button class="action-btn" onclick="openValeModal(${f.id}, '${f.nome}')" title="Lan√ßar Vale" style="color: #ffaa00;">üí∏</button>` : `<span class="action-btn" title="Inativo" style="opacity: 0.2; cursor: not-allowed;">üí∏</span>`}
                    <button class="action-btn" onclick="openModal(${id = f.id})" title="Perfil / Gest√£o" style="color: var(--primary-neon);">‚öôÔ∏è</button>
                    </div>
                </td>
            `;
                tbody.appendChild(tr);
            });
        }

        // --- Vales ---
        function openValeModal(id, nome) {
            document.getElementById('valeFuncId').value = id;
            document.getElementById('valeFuncNome').textContent = nome;
            document.getElementById('valeValor').value = '';
            document.getElementById('valeData').value = new Date().toISOString().split('T')[0];
            document.getElementById('valeDesc').value = `Vale - ${nome}`;
            document.getElementById('valeModal').classList.add('show');
        }

        async function saveVale(e) {
            e.preventDefault();
            const funcId = document.getElementById('valeFuncId').value;
            const valor = parseFloat(document.getElementById('valeValor').value);
            const vencimento = document.getElementById('valeData').value;
            const mesRef = vencimento.substring(0, 7); // AAAA-MM

            // 1. Verificar status do holerite
            const checkRes = await fetch(`/api/holerite/${funcId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: vencimento })
            });
            const checkData = await checkRes.json();

            if (checkData.status_pagamento === 'Pago') {
                if (!confirm(`O holerite de ${mesRef} j√° foi pago! Deseja lan√ßar este vale para o M√äS SEGUINTE automaticamente?`)) {
                    return;
                }
                // Ajusta para o dia 1 do m√™s seguinte
                const d = new Date(vencimento + 'T12:00:00');
                d.setMonth(d.getMonth() + 1);
                d.setDate(1);
                document.getElementById('valeData').value = d.toISOString().split('T')[0];
            } else if (valor > checkData.liquido) {
                const excedente = valor - checkData.liquido;
                if (!confirm(`Este valor (R$ ${valor.toFixed(2)}) √© MAIOR que o saldo l√≠quido (R$ ${checkData.liquido.toFixed(2)}).\n\nO excedente de R$ ${excedente.toFixed(2)} ser√° descontado no m√™s seguinte. Confirmar?`)) {
                    return;
                }
            }

            const data = {
                tipo: 'pagar',
                categoria: 'vale_funcionario',
                funcionario_id: funcId,
                valor: valor,
                vencimento: document.getElementById('valeData').value,
                descricao: document.getElementById('valeDesc').value,
                status: 'pago'
            };

            fetch('/api/contas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        alert("Vale lan√ßado com sucesso!");
                        document.getElementById('valeModal').classList.remove('show');
                        // Se o modal de perfil estiver aberto na aba de holerite, recalcula
                        if (document.getElementById('funcModal').classList.contains('show')) {
                            recalcHolerite();
                        }
                    } else {
                        alert("Erro: " + (res.error || 'Desconhecido'));
                    }
                });
        }

        let currentFuncIdGlobal = null;

        function switchTab(tabName) {
            // Esconde todas as abas
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            // Mostra a selecionada
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('btn-tab-' + tabName).classList.add('active');

            // Gatilhos de carregamento sob demanda
            if (tabName === 'historico') loadPeriodos();
            if (tabName === 'holerite') recalcHolerite();
            if (tabName === 'ponto') loadPontoRecords();
            if (tabName === 'desligamento') loadRescisaoCalc();
        }

        function openModal(id = null) {
            currentFuncIdGlobal = id;
            const modal = document.getElementById('funcModal');
            const form = document.getElementById('funcForm');
            form.reset();
            document.getElementById('funcId').value = '';

            // Reset de Tabs
            switchTab('cadastro');

            if (id) {
                const f = funcionarios.find(x => x.id === id);
                if (f) {
                    document.getElementById('funcId').value = f.id;
                    document.getElementById('nome').value = f.nome;
                    document.getElementById('cargo').value = f.cargo;
                    document.getElementById('salario_base').value = f.salario_base;
                    document.getElementById('inss_percent').value = f.inss_percent || 0.11;
                    document.getElementById('fgts_percent').value = f.fgts_percent || 0.08;
                    document.getElementById('descontos_json').value = f.descontos_json || '[]';
                    document.getElementById('nome_ponto').value = f.nome_ponto || '';
                    document.getElementById('modalTitle').textContent = `Perfil: ${f.nome}`;
                    document.getElementById('contratacaoGroup').style.display = 'none';

                    // Cache de IDs para abas
                    currentFuncIdPeriodos = id;
                    currentFuncIdPonto = id;
                    currentFuncIdRescisao = id; // J√° existia no c√≥digo anterior para rescis√£o

                    // Mostra/Esconde aba de desligamento dependendo do status
                    document.getElementById('btn-tab-desligamento').style.display = (f.status_emprego === 'Ativo') ? 'block' : 'none';

                    // Month defaults
                    const now = new Date();
                    const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    document.getElementById('holeriteMes').value = monthStr;
                    document.getElementById('pontoMes').value = monthStr;
                    document.getElementById('rescisaoData').value = now.toISOString().split('T')[0];
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Novo Funcion√°rio';
                document.getElementById('contratacaoGroup').style.display = 'block';
                document.getElementById('data_contratacao').value = new Date().toISOString().split('T')[0];

                // Esconde outras abas para novo cadastro (n√£o tem hist√≥rico ainda)
                document.getElementById('btn-tab-historico').style.display = 'none';
                document.getElementById('btn-tab-holerite').style.display = 'none';
                document.getElementById('btn-tab-ponto').style.display = 'none';
                document.getElementById('btn-tab-desligamento').style.display = 'none';
            }
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('funcModal').classList.remove('show');
        }

        function saveFunc(e) {
            e.preventDefault();
            const id = document.getElementById('funcId').value;
            const data = {
                nome: document.getElementById('nome').value,
                cargo: document.getElementById('cargo').value,
                salario_base: parseFloat(document.getElementById('salario_base').value),
                inss_percent: parseFloat(document.getElementById('inss_percent').value),
                fgts_percent: parseFloat(document.getElementById('fgts_percent').value),
                descontos_json: JSON.parse(document.getElementById('descontos_json').value || '[]'),
                nome_ponto: document.getElementById('nome_ponto').value,
                data_contratacao: document.getElementById('data_contratacao').value
            };

            const url = id ? `/api/funcionarios/${id}` : '/api/funcionarios';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => {
                if (res.success) {
                    closeModal();
                    loadFuncionarios();
                } else {
                    alert('Erro ao salvar');
                }
            });
        }

        function deleteFunc(id) {
            if (!confirm('Deseja excluir?')) return;
            fetch(`/api/funcionarios/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(res => {
                    if (res.success) loadFuncionarios();
                });
        }

        // --- Importa√ß√£o Ponto ---
        function openImportModal() {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('importLog').style.display = 'none';
            document.getElementById('importLog').innerHTML = '';
        }

        function uploadPonto() {
            const fileInput = document.getElementById('pontoFile');
            if (!fileInput.files[0]) return alert("Selecione um arquivo");

            const fd = new FormData();
            fd.append('file', fileInput.files[0]);

            fetch('/api/ponto/upload', {
                method: 'POST',
                body: fd
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        document.getElementById('importLog').style.display = 'block';
                        document.getElementById('importLog').innerHTML = "<b>Importado com sucesso!</b><br>" + res.logs.join('<br>');
                        loadFuncionarios(); // Refresh to see matched names
                    } else {
                        alert("Erro: " + res.error);
                    }
                })
                .catch(err => alert("Erro requisi√ß√£o: " + err));
        }

        // --- Visualizar Ponto ---
        function openPontoModal(id, nome) {
            openModal(id);
            switchTab('ponto');
        }

        // --- Hist√≥rico de Per√≠odos ---
        let currentFuncIdPeriodos = null;
        let periodosCached = [];

        function openPeriodoModal(id, nome) {
            openModal(id);
            switchTab('historico');
        }

        function loadPeriodos() {
            if (!currentFuncIdPeriodos) return;
            fetch(`/api/funcionarios/${currentFuncIdPeriodos}/periodos`)
                .then(r => r.json())
                .then(data => {
                    periodosCached = data;
                    const tbody = document.getElementById('periodoListBody');
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px;">Nenhum per√≠odo registrado.</td></tr>';
                        return;
                    }
                    data.forEach(p => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid var(--glass-border)';
                        tr.innerHTML = `
                        <td style="padding:12px; color: var(--text-primary);">${p.data_contratacao}</td>
                        <td style="padding:12px;">${p.data_demissao ? `<span style="color:var(--danger-color)">${p.data_demissao}</span>` : '<span style="color:var(--primary-neon); font-weight: 600;">Vigente</span>'}</td>
                        <td style="padding:12px; font-style: italic; color: var(--text-muted);">${p.motivo_saida || '-'}</td>
                        <td style="padding:12px; text-align: center;">
                            <div class="flex gap-10" style="justify-content: center;">
                                <button class="action-btn" onclick="editPeriod(${p.id})">‚úèÔ∏è</button>
                                <button class="action-btn" onclick="deletePeriod(${p.id})" style="color:var(--danger-color)">üóëÔ∏è</button>
                            </div>
                        </td>
                    `;
                        tbody.appendChild(tr);
                    });
                });
        }

        function openNewPeriodForm() {
            document.getElementById('periodId').value = '';
            document.getElementById('p_data_contratacao').value = '';
            document.getElementById('p_data_demissao').value = '';
            document.getElementById('p_motivo_saida').value = '';
            document.getElementById('periodFormTitle').textContent = 'Novo Per√≠odo';
            document.getElementById('periodFormContainer').style.display = 'block';
        }

        function closePeriodForm() {
            document.getElementById('periodFormContainer').style.display = 'none';
        }

        function editPeriod(periodId) {
            const p = periodosCached.find(x => x.id === periodId);
            if (!p) return;
            document.getElementById('periodId').value = p.id;
            document.getElementById('p_data_contratacao').value = p.data_contratacao;
            document.getElementById('p_data_demissao').value = p.data_demissao || '';
            document.getElementById('p_motivo_saida').value = p.motivo_saida || '';
            document.getElementById('periodFormTitle').textContent = 'Editar Per√≠odo';
            document.getElementById('periodFormContainer').style.display = 'block';
        }

        function savePeriod(e) {
            e.preventDefault();
            const periodId = document.getElementById('periodId').value;
            const data = {
                data_contratacao: document.getElementById('p_data_contratacao').value,
                data_demissao: document.getElementById('p_data_demissao').value,
                motivo_saida: document.getElementById('p_motivo_saida').value
            };

            const url = periodId ? `/api/funcionarios/periodos/${periodId}` : `/api/funcionarios/${currentFuncIdPeriodos}/periodos`;
            const method = periodId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => {
                if (res.success) {
                    closePeriodForm();
                    loadPeriodos();
                    loadFuncionarios(); // Refresh status on main table
                } else {
                    alert('Erro ao salvar per√≠odo');
                }
            });
        }

        function deletePeriod(periodId) {
            if (!confirm('Deseja excluir este per√≠odo?')) return;
            fetch(`/api/funcionarios/periodos/${periodId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        loadFuncionarios();
                    }
                });
        }

        function loadPontoRecords() {
            if (!currentFuncIdPonto) return;
            const mes = document.getElementById('pontoMes').value;

            fetch(`/api/ponto/registros?funcionario_id=${currentFuncIdPonto}&month=${mes}`)
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('pontoBody');
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:10px;">Nenhum registro encontrado neste m√™s.</td></tr>';
                        return;
                    }

                    data.forEach(r => {
                        const d = new Date(r.data + 'T12:00:00');
                        const dia = d.getDate();
                        const semana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'][d.getDay()];

                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid var(--glass-border)';
                        tr.innerHTML = `
                    <td style="padding:10px; color: var(--text-primary);"><b>${dia}</b> <small style="color: var(--text-muted)">${semana}</small></td>
                    <td style="padding:10px; color: #00ff88; font-family: 'JetBrains Mono';">${r.entrada_1 || '-'}</td>
                    <td style="padding:10px; color: #ffaa00; font-family: 'JetBrains Mono';">${r.saida_1 || '-'}</td>
                    <td style="padding:10px; color: #00ff88; font-family: 'JetBrains Mono';">${r.entrada_2 || '-'}</td>
                    <td style="padding:10px; color: #ffaa00; font-family: 'JetBrains Mono';">${r.saida_2 || '-'}</td>
                    <td style="padding:10px;">
                        <span style="font-size: 0.8rem; background: rgba(0,243,255,0.1); color: var(--primary-neon); padding: 2px 8px; border-radius: 4px;">${r.status || 'OK'}</span>
                    </td>
                 `;
                        tbody.appendChild(tr);
                    });
                });
        }

        function showHolerite(id) {
            openModal(id);
            switchTab('holerite');
        }

        function recalcHolerite() {
            const id = currentFuncIdGlobal;
            if (!id) return;

            const mes = document.getElementById('holeriteMes').value;
            const dataRef = mes + '-01';

            fetch(`/api/holerite/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: dataRef })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.error) return alert(data.error);

                    const statusColor = data.status_pagamento === 'Pago' ? '#27ae60' : '#f39c12';
                    const btnFinalizar = document.getElementById('btnFinalizarFinanceiro');
                    if (data.status_pagamento === 'Pago') {
                        btnFinalizar.disabled = true;
                        btnFinalizar.style.opacity = '0.5';
                        btnFinalizar.textContent = '‚úÖ J√° Lan√ßado no Financeiro';
                    } else {
                        btnFinalizar.disabled = false;
                        btnFinalizar.style.opacity = '1';
                        btnFinalizar.textContent = 'üí∞ Lan√ßar no Financeiro';
                    }

                    const html = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; padding:15px; background: rgba(255,255,255,0.03); border-radius:12px; border: 1px solid var(--glass-border); border-left: 4px solid ${statusColor};">
                        <span>Status de Pagamento: <b style="color: ${statusColor}">${data.status_pagamento}</b></span>
                        ${data.pago_em ? `<span class="text-muted">Processado em: ${data.pago_em}</span>` : ''}
                    </div>
                    <div style="text-align:center; margin-bottom:25px;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary);">${data.funcionario}</div>
                        <div class="text-muted">${data.referencia}</div>
                    </div>
                    <div class="holerite-item">
                        <span>Provento: Sal√°rio Base</span>
                        <span style="font-family: 'JetBrains Mono';">R$ ${data.salario_base.toFixed(2)}</span>
                    </div>
                    <div class="holerite-item" style="color: #ff4444;">
                        <span>Desconto: INSS (${(data.inss_percent * 100).toFixed(1)}%)</span>
                        <span style="font-family: 'JetBrains Mono';">- R$ ${data.inss_val.toFixed(2)}</span>
                    </div>
                    ${data.vales_val > 0 ? `
                    <div class="holerite-item" style="color: #ffaa00;">
                        <span>Desconto: Adiantamentos (Vales)</span>
                        <span style="font-family: 'JetBrains Mono';">- R$ ${data.vales_val.toFixed(2)}</span>
                    </div>` : ''}
                    ${data.saldo_devedor_anterior > 0 ? `
                        <div class="holerite-item" style="color: #ff4444; font-weight: bold;">
                            <span>D√©bito: Pend√™ncia de Meses Anteriores üö©</span>
                            <span style="font-family: 'JetBrains Mono';">- R$ ${data.saldo_devedor_anterior.toFixed(2)}</span>
                        </div>` : ''}
                    ${data.outros_descontos.map(d => `
                        <div class="holerite-item" style="color: #ff4444;">
                            <span>Desconto: ${d.tipo}</span>
                            <span style="font-family: 'JetBrains Mono';">- R$ ${d.valor.toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="holerite-item" style="color: var(--accent-cyan); border-bottom: none; opacity: 0.7;">
                        <span>Informativo: FGTS (Provis√£o)</span>
                        <span style="font-family: 'JetBrains Mono';">(R$ ${data.fgts_val.toFixed(2)})</span>
                    </div>
                    <div class="holerite-total">
                        <span style="font-size: 1rem; color: var(--text-muted);">Total L√≠quido</span>
                        <span style="color: var(--primary-neon);">R$ ${data.liquido.toFixed(2)}</span>
                    </div>
                    ${data.excedente_para_proximo > 0 ? `
                    <div style="margin-top:15px; color:#ff4444; font-size:0.85em; text-align:right; font-style: italic;">
                        * Excedente de R$ ${data.excedente_para_proximo.toFixed(2)} ser√° retido para o pr√≥ximo ciclo.
                    </div>` : ''}
                `;
                    document.getElementById('holeriteContent').innerHTML = html;
                });
        }

        function printHolerite() {
            const id = currentFuncIdGlobal;
            if (!id) return;
            const mes = document.getElementById('holeriteMes').value;
            window.open(`/holerite/print/${id}?mes=${mes}`, '_blank');
        }

        function finalizeHolerite() {
            const id = currentFuncIdGlobal;
            const mes = document.getElementById('holeriteMes').value;
            if (!id || !mes) return;

            if (!confirm(`Deseja LAN√áAR O PAGAMENTO de ${mes} no financeiro? Isso criar√° um registro de despesa.`)) return;

            fetch(`/api/holerite/${id}/finalize`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ month: mes })
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        alert("Pagamento lan√ßado no financeiro com sucesso!");
                        recalcHolerite(); // Refresh view
                    } else {
                        alert("Erro: " + res.error);
                    }
                });
        }

        function bulkHolerite() {
            const now = new Date();
            const defMes = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const mes = prompt("Informe o m√™s para gerar rascunhos (AAAA-MM):", defMes);
            if (!mes) return;

            fetch(`/api/holerite/bulk`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ month: mes })
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        alert(`Foram gerados/analisados ${res.count} holerites.`);
                    } else {
                        alert("Erro: " + res.error);
                    }
                });
        }

        // --- Rescis√£o ---
        let currentFuncIdRescisao = null; // Mantido por compatibilidade

        function openRescisaoModal(id, nome) {
            openModal(id);
            switchTab('desligamento');
        }

        function loadRescisaoCalc() {
            const dataDem = document.getElementById('rescisaoData').value;
            if (!dataDem) return;

            fetch(`/api/funcionarios/${currentFuncIdRescisao}/rescisao_calc`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data_demissao: dataDem })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('rescisaoResult').style.display = 'none';
                        return alert(data.error);
                    }
                    const resDiv = document.getElementById('rescisaoResult');
                    resDiv.style.display = 'block';
                    resDiv.innerHTML = `
                    <div style="font-size:0.9em;">
                        <strong>In√≠cio:</strong> ${data.data_inicio} <br>
                        <strong>Saldo Sal√°rio:</strong> R$ ${data.saldo_salario.toFixed(2)} <br>
                        <strong>13¬∫ Prop:</strong> R$ ${data.decimo_terceiro.toFixed(2)} <br>
                        <strong>F√©rias Prop:</strong> R$ ${data.ferias_prop.toFixed(2)} <br>
                        <strong>1/3 F√©rias:</strong> R$ ${data.terco_ferias.toFixed(2)} <br>
                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #ffe58f;">
                        <span style="font-size:1.1em; font-weight:bold; color:var(--danger-color);">
                            Total Estimado: R$ ${data.total_estimado.toFixed(2)}
                        </span>
                    </div>
                `;
                });
        }

        function confirmDismissal() {
            const dataDem = document.getElementById('rescisaoData').value;
            const motivo = document.getElementById('rescisaoMotivo').value;

            console.log("Confirming dismissal for:", currentFuncIdRescisao, dataDem, motivo);

            // Busca os per√≠odos para achar o atual aberto
            fetch(`/api/funcionarios/${currentFuncIdRescisao}/periodos`)
                .then(r => r.json())
                .then(periodos => {
                    console.log("Found periods:", periodos);
                    const pAtivo = periodos.find(p => !p.data_demissao);
                    if (!pAtivo) {
                        console.error("No active period found.");
                        return alert("Erro: N√£o foi encontrado um per√≠odo ativo para este funcion√°rio.");
                    }

                    console.log("Updating period:", pAtivo.id);
                    fetch(`/api/funcionarios/periodos/${pAtivo.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            data_contratacao: pAtivo.data_contratacao,
                            data_demissao: dataDem,
                            motivo_saida: motivo
                        })
                    }).then(r => r.json()).then(res => {
                        console.log("Update result:", res);
                        if (res.success) {
                            alert("Demiss√£o processada e registrada com sucesso!");
                            document.getElementById('rescisaoModal').classList.remove('show');
                            loadFuncionarios();
                        } else {
                            alert("Erro ao processar demiss√£o.");
                        }
                    }).catch(err => console.error("Update fetch error:", err));
                }).catch(err => console.error("List periods fetch error:", err));
        }

        // Load on start
        loadFuncionarios();

    </script>
    {% endblock %}