{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/consolidado.css') }}">
{% endblock %}

{% block content %}
<div class="clientes-container">
    <div class="flex-between mb-20">
        <div>
            <h1 style="margin:0;">Cadastro de Clientes</h1>
        </div>
        <div class="flex gap-10">
            <button class="btn" onclick="openModal()">+ Novo Cliente</button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section glass-panel mb-20" style="padding: 20px;">
        <div class="flex gap-10" style="align-items: flex-end;">
            <div class="form-group" style="flex: 1;">
                <label>Buscar</label>
                <input type="text" id="searchInput" placeholder="Nome, CPF, Email..." oninput="filterTable()">
            </div>
            <div class="form-group" style="width: 200px;">
                <label>Status</label>
                <select id="statusFilter" onchange="filterTable()">
                    <option value="">Todos</option>
                    <option value="ativo">Ativo</option>
                    <option value="inativo">Inativo</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="clearFilters()"
                style="height: 45px; border-radius: 12px;">Limpar</button>
        </div>
    </div>

    <!-- Tabela de Clientes -->
    <div class="glass-panel" style="padding: 20px;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>CPF/CNPJ</th>
                    <th>Telefone</th>
                    <th>Email</th>
                    <th>Cidade</th>
                    <th>Status</th>
                    <th>√öltimo Or√ßamento</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="clientesListBody">
                <!-- Preenchido via JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal Cadastro/Edi√ß√£o -->
    <div id="clienteModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); z-index: 1000; justify-content: center; align-items: center;">
        <div class="glass-panel neon-border-cyan"
            style="width: 800px; max-height: 90vh; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 20px;">
            <h2 id="modalTitle"
                style="margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; color: var(--primary-neon);">
                Novo Cliente
            </h2>
            <form id="clienteForm" onsubmit="saveCliente(event)">
                <input type="hidden" id="clienteId">

                <!-- Dados Pessoais -->
                <div class="form-section">
                    <h3>üìã Dados Pessoais</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label>Nome Completo *</label>
                            <input type="text" id="nome" required>
                        </div>
                        <div class="form-group">
                            <label>CPF/CNPJ *</label>
                            <input type="text" id="cpf_cnpj" required placeholder="000.000.000-00">
                        </div>
                        <div class="form-group">
                            <label>Data Nascimento</label>
                            <input type="date" id="data_nascimento">
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="tipo_pessoa">
                                <option value="fisica">Pessoa F√≠sica</option>
                                <option value="juridica">Pessoa Jur√≠dica</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Contato -->
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary-color);">üìû Contato</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Telefone *</label>
                            <input type="tel" id="telefone" required placeholder="(00) 00000-0000">
                        </div>
                        <div class="form-group">
                            <label>WhatsApp</label>
                            <input type="tel" id="whatsapp" placeholder="(00) 00000-0000">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Email *</label>
                            <input type="email" id="email" required>
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo -->
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary-color);">üìç Endere√ßo</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>CEP</label>
                            <input type="text" id="cep" placeholder="00000-000" onblur="buscarCep()">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Logradouro</label>
                            <input type="text" id="logradouro" placeholder="Rua, Avenida, etc.">
                        </div>
                        <div class="form-group">
                            <label>N√∫mero</label>
                            <input type="text" id="numero" placeholder="123">
                        </div>
                        <div class="form-group">
                            <label>Complemento</label>
                            <input type="text" id="complemento" placeholder="Apto, Casa, etc.">
                        </div>
                        <div class="form-group">
                            <label>Bairro</label>
                            <input type="text" id="bairro">
                        </div>
                        <div class="form-group">
                            <label>Cidade *</label>
                            <input type="text" id="cidade" required>
                        </div>
                        <div class="form-group">
                            <label>Estado *</label>
                            <select id="estado" required>
                                <option value="">Selecione...</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amap√°</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Cear√°</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="GO">Goi√°s</option>
                                <option value="MA">Maranh√£o</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Par√°</option>
                                <option value="PB">Para√≠ba</option>
                                <option value="PR">Paran√°</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piau√≠</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rond√¥nia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes Adicionais -->
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary-color);">‚ÑπÔ∏è Informa√ß√µes Adicionais</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="status">
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Como nos Conheceu?</label>
                            <select id="origem">
                                <option value="">Selecione...</option>
                                <option value="indicacao">Indica√ß√£o</option>
                                <option value="google">Google</option>
                                <option value="facebook">Facebook</option>
                                <option value="instagram">Instagram</option>
                                <option value="site">Site</option>
                                <option value="outdoor">Outdoor</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label>Observa√ß√µes</label>
                            <textarea id="observacoes" rows="3"
                                placeholder="Informa√ß√µes adicionais sobre o cliente..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let clientes = [];

    // Carregar clientes ao iniciar
    fetch('/api/clientes').then(r => r.json()).then(data => {
        clientes = data;
        renderTable(clientes);
    });

    function openModal(clienteId = null) {
        // Use inline style directly like in Orcamentos
        const modal = document.getElementById('clienteModal');
        const form = document.getElementById('clienteForm');
        const title = document.getElementById('modalTitle');

        form.reset();
        document.getElementById('clienteId').value = '';

        if (clienteId) {
            const cliente = clientes.find(c => c.id == clienteId);
            if (cliente) {
                document.getElementById('clienteId').value = cliente.id;
                document.getElementById('nome').value = cliente.nome || '';
                document.getElementById('cpf_cnpj').value = cliente.cpf_cnpj || '';
                document.getElementById('telefone').value = cliente.telefone || '';
                document.getElementById('email').value = cliente.email || '';

                // Fix: endereco -> logradouro + others
                document.getElementById('cep').value = cliente.cep || '';
                document.getElementById('logradouro').value = cliente.logradouro || '';
                document.getElementById('numero').value = cliente.numero || '';
                document.getElementById('complemento').value = cliente.complemento || '';
                document.getElementById('bairro').value = cliente.bairro || '';
                document.getElementById('cidade').value = cliente.cidade || '';
                document.getElementById('estado').value = cliente.estado || '';

                document.getElementById('tipo_pessoa').value = cliente.tipo_pessoa || 'fisica';
                document.getElementById('data_nascimento').value = cliente.data_nascimento || '';
                document.getElementById('whatsapp').value = cliente.whatsapp || '';

                // Status e outros
                document.getElementById('status').value = cliente.status || 'ativo';
                document.getElementById('origem').value = cliente.origem || '';
                document.getElementById('observacoes').value = cliente.observacoes || '';

                title.textContent = 'Editar Cliente';
            }
        } else {
            form.reset();
            title.textContent = 'Novo Cliente';
        }

        // Simple toggle display flex
        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('clienteModal').style.display = 'none';
        // Optional: refresh table if needed, but not full reload like budget
    }

    function saveCliente(event) {
        event.preventDefault();

        const clienteId = document.getElementById('clienteId').value;
        const data = {
            nome: document.getElementById('nome').value,
            cpf_cnpj: document.getElementById('cpf_cnpj').value,
            data_nascimento: document.getElementById('data_nascimento').value,
            tipo_pessoa: document.getElementById('tipo_pessoa').value,
            telefone: document.getElementById('telefone').value,
            whatsapp: document.getElementById('whatsapp').value,
            email: document.getElementById('email').value,
            cep: document.getElementById('cep').value,
            logradouro: document.getElementById('logradouro').value,
            numero: document.getElementById('numero').value,
            complemento: document.getElementById('complemento').value,
            bairro: document.getElementById('bairro').value,
            cidade: document.getElementById('cidade').value,
            estado: document.getElementById('estado').value,
            status: document.getElementById('status').value,
            origem: document.getElementById('origem').value,
            observacoes: document.getElementById('observacoes').value
        };

        const url = clienteId ? `/api/clientes/${clienteId}` : '/api/clientes';
        const method = clienteId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(r => r.json()).then(res => {
            if (res.success) {
                closeModal();
                fetch('/api/clientes').then(r => r.json()).then(data => {
                    clientes = data;
                    renderTable(clientes);
                });
            } else {
                alert('Erro ao salvar cliente');
            }
        });
    }

    function deleteCliente(id) {
        if (!confirm('Tem certeza que deseja excluir este cliente?')) return;

        fetch(`/api/clientes/${id}`, { method: 'DELETE' })
            .then(r => r.json()).then(res => {
                if (res.success) {
                    fetch('/api/clientes').then(r => r.json()).then(data => {
                        clientes = data;
                        renderTable(clientes);
                    });
                }
            });
    }

    function renderTable(data) {
        const tbody = document.getElementById('clientesListBody');
        tbody.innerHTML = '';

        data.forEach(cliente => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 12px; cursor:pointer;" onclick="window.location.href='/cliente/${cliente.id}'">
                    <span style="font-weight:bold; color:var(--primary-color);">${cliente.nome}</span>
                </td>
                <td style="padding: 12px;">${cliente.cpf_cnpj}</td>
                <td style="padding: 12px;">${cliente.telefone}</td>
                <td style="padding: 12px;">${cliente.email}</td>
                <td style="padding: 12px;">${cliente.cidade}</td>
                <td style="padding: 12px;">
                    <span class="status-badge status-${cliente.status}">${cliente.status}</span>
                </td>
                <td style="padding: 12px;">${cliente.ultimo_orcamento || '-'}</td>
                <td style="padding: 12px; text-align: center;">
                    <button class="action-btn" onclick="openModal(${cliente.id})" title="Editar">‚úèÔ∏è</button>
                    <button class="action-btn" onclick="deleteCliente(${cliente.id})" title="Excluir">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filterTable() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        // const cidade = document.getElementById('cidadeFilter').value.toLowerCase(); // Campo comentado

        const filtered = clientes.filter(cliente => {
            const matchSearch = !search ||
                cliente.nome.toLowerCase().includes(search) ||
                cliente.cpf_cnpj.includes(search) ||
                cliente.email.toLowerCase().includes(search);

            const matchStatus = !status || cliente.status === status;
            // const matchCidade = !cidade || cliente.cidade.toLowerCase().includes(cidade); // Campo comentado

            return matchSearch && matchStatus; // && matchCidade; // Removido filtro de cidade
        });

        renderTable(filtered);
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        // document.getElementById('cidadeFilter').value = ''; // Campo comentado
        renderTable(clientes);
    }

    function buscarCep() {
        const cep = document.getElementById('cep').value.replace(/\D/g, '');
        if (cep.length !== 8) return;

        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(r => r.json())
            .then(data => {
                if (!data.erro) {
                    document.getElementById('logradouro').value = data.logradouro;
                    document.getElementById('bairro').value = data.bairro;
                    document.getElementById('cidade').value = data.localidade;
                    document.getElementById('estado').value = data.uf;
                    document.getElementById('numero').focus();
                }
            })
            .catch(error => console.error('Erro ao buscar CEP:', error));
    }

    // Formata√ß√£o de campos
    document.getElementById('cpf_cnpj')?.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        } else {
            value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        }
        e.target.value = value;
    });

    document.getElementById('telefone')?.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        e.target.value = value;
    });

    document.getElementById('whatsapp')?.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        e.target.value = value;
    });

    document.getElementById('cep')?.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
        e.target.value = value;
    });
</script>
{% endblock %}